<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Troy Admin Panel</title>
  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --border:#e5e7eb;
      --primary:#667eea;
      --primary-600:#5a6fe0;
      --success:#22c55e;
      --error:#ef4444;
      --warning:#f59e0b;
      --shadow:0 10px 20px rgba(0,0,0,.06);
      --radius:14px;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif;
      background:linear-gradient(135deg,#f4f6ff 0%, #eef2ff 30%, #f9fafb 100%);
      color:var(--text);
    }
    .container{max-width:1200px;margin:0 auto;padding:28px}
    .header{
      background:linear-gradient(135deg,#ffffff, #f7f8ff);
      padding:24px 24px;
      border-radius:var(--radius);
      margin-bottom:20px;
      box-shadow:var(--shadow);
      display:flex;justify-content:space-between;align-items:center
    }
    .brand{
      display:flex;gap:14px;align-items:center
    }
    .logo{
      width:42px;height:42px;border-radius:12px;
      background:linear-gradient(135deg,var(--primary),#8aa4ff);
      box-shadow:0 10px 20px rgba(102,126,234,.35);
      display:grid;place-items:center;color:#fff;font-weight:800
    }
    .header h1{font-size:22px}
    .stats{display:flex;gap:12px}
    .stat{
      background:#fff;border:1px solid var(--border);
      border-radius:12px;padding:10px 14px;display:flex;gap:8px;align-items:center;
      color:var(--muted)
    }
    .stat strong{color:var(--text)}
    .tabs{
      display:flex;gap:10px;margin:16px 0 20px
    }
    .tab{
      padding:10px 16px;background:#fff;border:1px solid var(--border);
      border-radius:999px;cursor:pointer;color:var(--text);
      transition:all .2s ease;font-weight:600
    }
    .tab:hover{transform:translateY(-1px)}
    .tab.active{background:var(--primary);color:#fff;border-color:transparent;box-shadow:0 10px 20px rgba(102,126,234,.3)}
    .content{
      background:var(--card);padding:26px;border-radius:var(--radius);
      box-shadow:var(--shadow)
    }
    .content h2{font-size:18px;margin-bottom:18px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .form-group{display:flex;flex-direction:column;gap:10px}
    label{font-weight:700;color:#374151}
    input, textarea, select{
      width:100%;padding:12px 14px;font-size:14px;
      border:2px solid var(--border);border-radius:12px;background:#fff;
      transition:border-color .15s ease, box-shadow .15s ease
    }
    input:focus, textarea:focus, select:focus{
      outline:none;border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(102,126,234,.15)
    }
    textarea{min-height:160px;resize:vertical}
    .actions{display:flex;gap:10px;align-items:center}
    button{
      padding:12px 18px;background:var(--primary);color:#fff;border:none;
      border-radius:12px;cursor:pointer;font-weight:700;
      box-shadow:0 10px 20px rgba(102,126,234,.25);
      transition:transform .1s ease, opacity .2s ease
    }
    button:hover{transform:translateY(-1px)}
    button.secondary{background:#fff;color:var(--text);border:1px solid var(--border);box-shadow:none}
    button:disabled{opacity:.6;cursor:not-allowed}
    .btn-loading{position:relative;color:transparent !important}
    .btn-loading::after{
      content:"";width:18px;height:18px;border-radius:50%;
      border:3px solid currentColor;border-top-color:transparent;
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      animation:spin .8s linear infinite
    }
    @keyframes spin{to{transform:translate(-50%,-50%) rotate(360deg)}}

    /* Document list */
    .document-list{margin-top:10px;display:grid;grid-template-columns:1fr;gap:12px}
    .document-item{
      padding:14px;border:1px solid var(--border);border-radius:14px;
      display:flex;justify-content:space-between;align-items:center;gap:12px;
      background:#fff;transition:transform .12s ease, box-shadow .12s ease
    }
    .document-item:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
    .doc-meta{display:flex;flex-direction:column;gap:6px}
    .badge{
      display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;
      background:#eef2ff;color:#4f46e5;border:1px solid #e0e7ff
    }
    .muted{color:var(--muted);font-size:12px}
    .empty{
      border:2px dashed var(--border);border-radius:14px;padding:28px;text-align:center;color:var(--muted)
    }

    /* Toasts */
    .toast-container{
      position:fixed;right:18px;top:18px;display:flex;flex-direction:column;gap:10px;z-index:9999
    }
    .toast{
      min-width:240px;max-width:360px;padding:12px 14px;border-radius:12px;
      box-shadow:var(--shadow);display:flex;gap:10px;align-items:flex-start;color:#0f172a;background:#fff;border:1px solid var(--border);
      animation:slideIn .22s ease;
    }
    .toast.success{border-color:#bbf7d0;background:#ecfdf5}
    .toast.error{border-color:#fecaca;background:#fef2f2}
    .toast.info{border-color:#dbeafe;background:#eff6ff}
    .toast .title{font-weight:800;margin-bottom:2px}
    .toast .close{margin-left:auto;background:transparent;border:none;cursor:pointer;font-weight:800}
    @keyframes slideIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}

    /* Confirm modal */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:center;justify-content:center;z-index:9998
    }
    .modal{
      width:100%;max-width:420px;background:#fff;border-radius:16px;padding:20px;border:1px solid var(--border);box-shadow:var(--shadow)
    }
    .modal h3{margin-bottom:8px}
    .modal .modal-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:16px}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <div class="logo">T</div>
        <div>
          <h1>Troy Admin Panel</h1>
          <div class="muted">Belgeleri ve eğitim içeriklerini yönetin</div>
        </div>
      </div>
      <div class="stats">
        <div class="stat">📄 <span>Toplam Döküman: <strong id="totalDocs">0</strong></span></div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="showTab(event,'upload')">Döküman Ekle</button>
      <button class="tab" onclick="showTab(event,'training')">Eğitim Ekle</button>
      <button class="tab" onclick="showTab(event,'manage')">Yönet</button>
    </div>

    <!-- Upload -->
    <div id="upload-tab" class="content">
      <h2>Yeni Döküman Ekle</h2>
      <div class="grid">
        <div class="form-group">
          <label>Başlık</label>
          <input type="text" id="doc-title" placeholder="Örn: Kullanım Kılavuzu v1" />
        </div>
        <div class="form-group">
          <label>Kategori</label>
          <select id="doc-category">
            <option>Kullanıcı Kılavuzu</option>
            <option>Talimat</option>
            <option>Genel</option>
          </select>
        </div>
      </div>
      <div class="form-group" style="margin-top:12px">
        <label>İçerik</label>
        <textarea id="doc-content" placeholder="Döküman içeriğini buraya yazın…"></textarea>
      </div>
      <div class="actions">
        <button id="btn-upload" onclick="uploadDocument()">Kaydet</button>
        <button class="secondary" onclick="resetDocForm()">Temizle</button>
      </div>
    </div>

    <!-- Training -->
    <div id="training-tab" class="content" style="display:none;">
      <h2>Yeni Eğitim İçeriği</h2>
      <div class="grid">
        <div class="form-group">
          <label>Başlık</label>
          <input type="text" id="train-title" placeholder="Örn: Kasa Açılış Eğitimi" />
        </div>
        <div class="form-group">
          <label>Etiketler (opsiyonel)</label>
          <input type="text" id="train-tags" placeholder="Örn: kasa, eğitim, başlangıç" />
        </div>
      </div>
      <div class="form-group">
        <label>Açıklama</label>
        <textarea id="train-desc" placeholder="Eğitim içeriğinin özeti…"></textarea>
      </div>
      <div class="form-group">
        <label>Adımlar (Her satır bir adım)</label>
        <textarea id="train-steps" placeholder="1) …&#10;2) …"></textarea>
      </div>
      <div class="actions">
        <button id="btn-train" onclick="createTraining()">Kaydet</button>
        <button class="secondary" onclick="resetTrainForm()">Temizle</button>
      </div>
    </div>

    <!-- Manage -->
    <div id="manage-tab" class="content" style="display:none;">
      <h2>Dökümanlar</h2>
      <div id="documents" class="document-list">
        <div class="empty" id="docs-empty">Veri yükleniyor…</div>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-container" id="toast-container"></div>

  <!-- Confirm modal -->
  <div class="modal-backdrop" id="confirm-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="confirm-title">
      <h3 id="confirm-title">Emin misiniz?</h3>
      <div id="confirm-message" class="muted">Bu işlem geri alınamaz.</div>
      <div class="modal-actions">
        <button class="secondary" id="confirm-cancel">Vazgeç</button>
        <button id="confirm-ok">Evet, sil</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:8000';

    // ---------- UI Helpers ----------
    const qs = (sel, el=document)=>el.querySelector(sel);
    const qsa = (sel, el=document)=>[...el.querySelectorAll(sel)];

    function showTab(ev, tab){
      qsa('.tab').forEach(t => t.classList.remove('active'));
      ev.currentTarget.classList.add('active');

      qsa('.content').forEach(c => c.style.display='none');
      qs(`#${tab}-tab`).style.display='block';

      if(tab==='manage') loadDocuments();
    }

    function setLoading(btn, loading){
      if(!btn) return;
      if(loading){
        btn.dataset.label = btn.textContent;
        btn.classList.add('btn-loading');
        btn.disabled = true;
      } else {
        btn.classList.remove('btn-loading');
        btn.disabled = false;
        if(btn.dataset.label) btn.textContent = btn.dataset.label;
      }
    }

    function showToast(type='info', title='Bilgi', message=''){
      const wrap = qs('#toast-container');
      const el = document.createElement('div');
      el.className = `toast ${type}`;
      el.innerHTML = `
        <div style="font-size:18px;line-height:1.1">${type==='success'?'✅':type==='error'?'⛔':'ℹ️'}</div>
        <div>
          <div class="title">${title}</div>
          ${message?`<div class="muted">${message}</div>`:''}
        </div>
        <button class="close" aria-label="Kapat">×</button>
      `;
      el.querySelector('.close').onclick = ()=> el.remove();
      wrap.appendChild(el);
      setTimeout(()=>{ el.remove(); }, 3200);
    }

    function showConfirm(message='Emin misiniz?'){
      return new Promise(resolve=>{
        const backdrop = qs('#confirm-backdrop');
        const msg = qs('#confirm-message');
        msg.textContent = message;
        backdrop.style.display='flex';
        function cleanup(ans){
          backdrop.style.display='none';
          ok.removeEventListener('click', onOk);
          cancel.removeEventListener('click', onCancel);
          resolve(ans);
        }
        const ok = qs('#confirm-ok');
        const cancel = qs('#confirm-cancel');
        function onOk(){ cleanup(true); }
        function onCancel(){ cleanup(false); }
        ok.addEventListener('click', onOk);
        cancel.addEventListener('click', onCancel);
      });
    }

    function resetDocForm(){
      qs('#doc-title').value='';
      qs('#doc-content').value='';
      qs('#doc-category').selectedIndex=0;
    }
    function resetTrainForm(){
      qs('#train-title').value='';
      qs('#train-desc').value='';
      qs('#train-steps').value='';
      qs('#train-tags').value='';
    }

    // ---------- API Calls ----------
    async function uploadDocument(){
      const btn = qs('#btn-upload');
      const title = qs('#doc-title').value.trim();
      const content = qs('#doc-content').value.trim();
      const category = qs('#doc-category').value;

      if(!title || !content){
        showToast('error','Eksik bilgi','Başlık ve içerik zorunludur.');
        return;
      }

      setLoading(btn,true);
      try{
        const res = await fetch(`${API_URL}/admin/upload-document`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({title, content, category})
        });
        const result = await res.json().catch(()=>({}));
        if(res.ok && result?.success){
          showToast('success','Başarıyla kaydedildi','Döküman sisteme eklendi.');
          resetDocForm();
        }else{
          const msg = result?.error || `Sunucu hatası (HTTP ${res.status})`;
          showToast('error','Kaydedilemedi', msg);
        }
      }catch(err){
        showToast('error','Ağ hatası', String(err));
      }finally{
        setLoading(btn,false);
      }
    }

    async function createTraining(){
      const btn = qs('#btn-train');
      const title = qs('#train-title').value.trim();
      const description = qs('#train-desc').value.trim();
      const steps = qs('#train-steps').value
        .split('\n').map(s=>s.trim()).filter(Boolean);
      const tags = qs('#train-tags').value
        .split(',').map(t=>t.trim()).filter(Boolean);

      if(!title || !description || steps.length===0){
        showToast('error','Eksik bilgi','Başlık, açıklama ve en az 1 adım gerekli.');
        return;
      }

      setLoading(btn,true);
      try{
        const res = await fetch(`${API_URL}/admin/create-training`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({title, description, steps, tags})
        });
        const result = await res.json().catch(()=>({}));
        if(res.ok && result?.success){
          showToast('success','Başarıyla kaydedildi','Eğitim içeriği oluşturuldu.');
          resetTrainForm();
        }else{
          const msg = result?.error || `Sunucu hatası (HTTP ${res.status})`;
          showToast('error','Kaydedilemedi', msg);
        }
      }catch(err){
        showToast('error','Ağ hatası', String(err));
      }finally{
        setLoading(btn,false);
      }
    }

    async function loadDocuments(){
      const list = qs('#documents');
      list.innerHTML = `
        ${['','',''].map(()=>`
          <div class="document-item" aria-busy="true">
            <div class="doc-meta">
              <div style="height:12px;width:160px;background:#eef2ff;border-radius:6px"></div>
              <div style="height:10px;width:260px;background:#f3f4f6;border-radius:6px"></div>
            </div>
            <div style="height:34px;width:84px;background:#f3f4f6;border-radius:10px"></div>
          </div>
        `).join('')}
      `;

      try{
        const res = await fetch(`${API_URL}/admin/list-documents`);
        const data = await res.json();
        const docs = data?.documents || [];
        qs('#totalDocs').textContent = docs.length;

        if(!docs.length){
          list.innerHTML = `<div class="empty">Henüz döküman yok. Sağ üstten ekleyebilirsin.</div>`;
          return;
        }

        list.innerHTML = docs.map(d => {
          const title = d.title || 'Başlıksız';
          const preview = (d.preview || d.content || '').toString().slice(0,140);
          const category = d.category || 'Genel';
          return `
            <div class="document-item">
              <div class="doc-meta">
                <div><strong>${title}</strong></div>
                <div class="muted">${preview ? preview + '…' : ''}</div>
                <span class="badge">${category}</span>
              </div>
              <div class="actions">
                <button class="secondary" onclick="viewDoc('${d.id||''}')">Görüntüle</button>
                <button onclick="deleteDoc('${d.id||''}')">Sil</button>
              </div>
            </div>
          `;
        }).join('');
      }catch(err){
        list.innerHTML = `<div class="empty">Yükleme sırasında hata: ${String(err)}</div>`;
      }
    }

    function viewDoc(id){
      if(!id){ showToast('error','Bulunamadı','Geçersiz ID'); return; }
      showToast('info','Yolda','Detay sayfası henüz eklenmedi.');
    }

    async function deleteDoc(id){
      if(!id){ showToast('error','Bulunamadı','Geçersiz ID'); return; }
      const ok = await showConfirm('Bu dökümanı silmek istediğinize emin misiniz?');
      if(!ok) return;

      try{
        const res = await fetch(`${API_URL}/admin/document/${id}`, { method:'DELETE' });
        if(res.ok){
          showToast('success','Silindi','Döküman kaldırıldı.');
          loadDocuments();
        }else{
          showToast('error','Silinemedi',`Sunucu hatası (HTTP ${res.status})`);
        }
      }catch(err){
        showToast('error','Ağ hatası', String(err));
      }
    }

    // İlk yükte istatistik için dokümanları çekelim (Yönet sekmesine geçince de yeniler)
    loadDocuments();
  </script>
</body>
</html>
